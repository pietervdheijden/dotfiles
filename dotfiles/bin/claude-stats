#!/bin/bash

log_dir="$HOME/.claude/stats/sessions"

if [ ! -d "$log_dir" ] || [ -z "$(ls "$log_dir"/*.jsonl 2>/dev/null)" ]; then
    echo "No stat data found."
    exit 0
fi

# Aggregate costs per day across all JSONL files
cat "$log_dir"/*.jsonl 2>/dev/null | jq -rs '
    group_by(.timestamp[:10])
    | map({
        date: .[0].timestamp[:10],
        cost: (map(.cost_delta) | add),
        sessions: (map(.session_id) | unique | length),
        input_tokens: (map(.input_tokens_delta) | add),
        output_tokens: (map(.output_tokens_delta) | add)
    })
    | sort_by(.date)
    | . as $days
    | ($days | map(.cost) | add) as $total
    | $days[] | "\(.date)  $\(.cost | . * 100 | round / 100 | tostring | ltrimstr("0") )  (\(.sessions) sessions, \(.input_tokens) in, \(.output_tokens) out)"
    , "---"
    , "Total     $\($total | . * 100 | round / 100)"
'
